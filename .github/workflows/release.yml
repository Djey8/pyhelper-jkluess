name: Release and Publish

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (leave empty for auto-detection)'
        required: false
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper versioning
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine pytest
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install -e .
    
    - name: Run tests
      run: |
        pytest tests/ -v
    
    - name: Determine version bump
      id: version
      run: |
        # Get current version from setup.py
        CURRENT_VERSION=$(python -c "import re; content = open('setup.py').read(); match = re.search(r'version=[\"'"'"']([^\"'"'"']+)[\"'"'"']', content); print(match.group(1) if match else '0.0.0')")
        echo "Current version: $CURRENT_VERSION"
        
        # Check if this is the first release (no tags exist)
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          echo "No existing tags found - this is the first release"
          echo "Using version from setup.py: $CURRENT_VERSION"
          echo "new_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=initial" >> $GITHUB_OUTPUT
          echo "is_first_release=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # Split version into parts
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        # Determine bump type
        if [ -n "${{ github.event.inputs.version_bump }}" ] && [ "${{ github.event.inputs.version_bump }}" != "auto" ]; then
          BUMP_TYPE="${{ github.event.inputs.version_bump }}"
          echo "Manual version bump: $BUMP_TYPE"
        else
          # Auto-detect based on commit messages since last tag
          COMMITS=$(git log --pretty=format:"%s" $LAST_TAG..HEAD)
          
          echo "Analyzing commits since $LAST_TAG:"
          echo "$COMMITS"
          
          # Check for breaking changes (BREAKING CHANGE: or !) -> MAJOR
          if echo "$COMMITS" | grep -qiE "(BREAKING CHANGE:|^[^:]+!:)"; then
            BUMP_TYPE="major"
            echo "Detected BREAKING CHANGE -> major version bump"
          # Check for features (feat:) -> MINOR
          elif echo "$COMMITS" | grep -qiE "^feat(\([^)]*\))?:"; then
            BUMP_TYPE="minor"
            echo "Detected feature -> minor version bump"
          # Check for fixes or other changes -> PATCH
          elif echo "$COMMITS" | grep -qiE "^(fix|docs|style|refactor|perf|test|chore)(\([^)]*\))?:"; then
            BUMP_TYPE="patch"
            echo "Detected fix/improvement -> patch version bump"
          else
            echo "No conventional commits detected, skipping release"
            echo "skip_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi
        
        # Calculate new version
        case $BUMP_TYPE in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        echo "New version: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
    
    - name: Update version in setup.py
      if: steps.version.outputs.skip_release != 'true' && steps.version.outputs.is_first_release != 'true'
      run: |
        NEW_VERSION="${{ steps.version.outputs.new_version }}"
        sed -i "s/version=\"[^\"]*\"/version=\"$NEW_VERSION\"/" setup.py
        echo "Updated setup.py to version $NEW_VERSION"
    
    - name: Update version in __init__.py
      if: steps.version.outputs.skip_release != 'true' && steps.version.outputs.is_first_release != 'true'
      run: |
        NEW_VERSION="${{ steps.version.outputs.new_version }}"
        if [ -f "pyhelper_jkluess/__init__.py" ]; then
          sed -i "s/__version__ = \"[^\"]*\"/__version__ = \"$NEW_VERSION\"/" pyhelper_jkluess/__init__.py
          echo "Updated __init__.py to version $NEW_VERSION"
        fi
    
    - name: Commit version bump
      if: steps.version.outputs.skip_release != 'true' && steps.version.outputs.is_first_release != 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add setup.py pyhelper_jkluess/__init__.py
        git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }}"
        git push
    
    - name: Create Git Tag
      if: steps.version.outputs.skip_release != 'true'
      run: |
        git tag -a "v${{ steps.version.outputs.new_version }}" -m "Release v${{ steps.version.outputs.new_version }}"
        git push origin "v${{ steps.version.outputs.new_version }}"
    
    - name: Generate Release Notes
      if: steps.version.outputs.skip_release != 'true'
      id: release_notes
      run: |
        LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        if [ -z "$LAST_TAG" ]; then
          COMMITS=$(git log --pretty=format:"- %s (%h)" HEAD)
        else
          COMMITS=$(git log --pretty=format:"- %s (%h)" $LAST_TAG..HEAD^)
        fi
        
        # Create release notes
        cat << EOF > release_notes.md
        ## What's Changed
        
        $COMMITS
        
        **Version Type:** ${{ steps.version.outputs.bump_type }}
        
        **Full Changelog**: https://github.com/${{ github.repository }}/compare/${LAST_TAG}...v${{ steps.version.outputs.new_version }}
        EOF
        
        echo "Release notes created"
    
    - name: Create GitHub Release
      if: steps.version.outputs.skip_release != 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.new_version }}
        name: Release v${{ steps.version.outputs.new_version }}
        body_path: release_notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build package
      if: steps.version.outputs.skip_release != 'true'
      run: python -m build
    
    - name: Publish to PyPI
      if: steps.version.outputs.skip_release != 'true'
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        python -m twine upload dist/*
